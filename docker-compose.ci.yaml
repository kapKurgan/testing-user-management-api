# docker-compose.ci.yaml
# Файл конфигурации Docker Compose для CI/CD в GitHub Actions
# Определяет минимальный стенд для тестирования API управления пользователями

# Версия синтаксиса Docker Compose
version: '3.8'

# Определение сервисов (контейнеров)
services:
  # Имя сервиса - petstore-mock
  # Этот контейнер будет имитировать PetStore API для локального тестирования
  petstore-mock:
    # Конфигурация сборки Docker-образа
    build:
      # Контекст сборки - текущая директория (где находится docker-compose.ci.yaml)
      context: .
      # Имя Dockerfile для сборки базового образа
      dockerfile: Dockerfile.base

    # Имя контейнера после запуска (удобно для логов и отладки)
    container_name: petstore-mock

    # Проброс портов: порт хоста : порт контейнера
    # На хосте (внутри GitHub Actions runner) будет доступен порт 8080
    ports:
      - "8080:8080"

    # Переменные окружения внутри контейнера
    # SERVICE_MODE определяет режим работы сервиса (http-mock, grpc-mock и т.д.)
    environment:
      - SERVICE_MODE=http-mock

    # Healthcheck - проверка готовности сервиса к работе
    # Docker будет опрашивать этот эндпоинт, прежде чем считать сервис "здоровым"
    healthcheck:
      # Команда проверки: используем curl для запроса к API
      # Этот эндпоинт должен существовать в вашем mock-сервисе
      test: ["CMD", "curl", "-f", "http://localhost:8080/v2/user/login?username=test&password=test"]

      # Интервал между проверками (10 секунд)
      interval: 10s

      # Таймаут одной проверки (5 секунд)
      timeout: 5s

      # Количество попыток перед тем, как сервис считается "нездоровым"
      retries: 10

      # Время на первоначальный запуск сервиса (30 секунд)
      start_period: 30s