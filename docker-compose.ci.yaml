# docker-compose.ci.yaml
# Конфигурация Docker Compose для CI/CD (HTTP-only)
# Запускает один контейнер с полноценным mock PetStore API

version: '3.8'

services:
  # petstore-mock - единственный сервис для тестирования
  petstore-mock:
    # Сборка из Dockerfile.base в текущей директории
    build:
      context: .
      dockerfile: Dockerfile.base

    # Имя контейнера для удобства
    container_name: petstore-mock

    # Проброс портов: хост:контейнер
    # На хосте (GitHub Actions runner) будет доступен порт 8080
    ports:
      - "8080:8080"

    # Healthcheck - проверяет готовность сервиса
    # Запрашивает /health эндпоинт, который реализован в mock_petstore.py
    healthcheck:
      # Команда проверки с помощью curl
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]

      # Интервал между проверками (10 секунд)
      interval: 10s

      # Таймаут одной проверки (5 секунд)
      timeout: 5s

      # Количество попыток перед пометкой как "unhealthy"
      retries: 10

      # Время на первоначальный запуск (30 секунд)
      start_period: 30s

    # Перезапуск контейнера при сбое (необязательно, но полезно)
    restart: unless-stopped