# .github/workflows/api-tests.yml
# GitHub Actions workflow для тестирования API управления пользователями

name: API Tests

on:
  workflow_dispatch:
    inputs:
      SCENARIO:
        type: 'choice'
        default: ' '
        options:
          - '-m login'
          - '-m smoke'
          - '-m regression'
          - '-m user'
          - '-m create'
          - '-m login'
          - '-m update'
          - '-m delete'
          - '-m performance'
        required: true
        description: 'Выберите набор тестов для запуска'

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # Шаг 1: Клонирование репозитория
      - name: Клонирование репозитория
        uses: actions/checkout@v4

      # Шаг 2: Установка Python 3.12
      - name: Установка Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Шаг 3: Сборка Docker-образа mock-сервиса
      # Собирает образ из Dockerfile.base с тегом petstore-mock:latest
      - name: Сборка Docker-образа mock-сервиса
        run: docker build -f Dockerfile.base -t petstore-mock:latest .

      # Шаг 4: Запуск mock-сервиса в фоновом режиме
      # -d (detached) - запуск в фоне
      # --build - пересобирает перед запуском
      # --wait - ждет пока сервис станет healthy (требует Docker Compose v2.10+)
      - name: Запуск mock PetStore API
        run: docker compose -f docker-compose.ci.yaml up -d --build --wait

      # Шаг 5: Проверка статуса сервиса (на всякий случай)
      # Выводит логи и статус контейнера для отладки
      - name: Проверка статуса сервиса
        run: |
          echo "=== Container Status ==="
          docker compose -f docker-compose.ci.yaml ps
          echo "=== Container Logs ==="
          docker logs petstore-mock --tail 20

      # Шаг 6: Установка Python-зависимостей
      - name: Установка Python-зависимостей
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Шаг 7: Создание директории для отчетов
      - name: Создание директории отчетов
        run: mkdir -p ./reports/${{ github.run_id }}

      # Шаг 8: Запуск тестов
      # Передаем API_BASE_URL - важно для base_test.py
      # Сохраняем HTML-отчет в уникальную папку по ID запуска
      - name: Запуск тестов
        run: pytest ${{ github.event.inputs.SCENARIO }} --html=./reports/${{ github.run_id }}/index.html
        env:
          # Указываем mock-сервис вместо реального PetStore API
          API_BASE_URL: http://localhost:8080/v2

      # Шаг 9: Деплой отчетов в GitHub Pages
      - name: Деплой отчетов в GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          keep_files: true
          publish_dir: reports
          publish_branch: gh-pages

      # Шаг 10: Остановка и очистка Docker-контейнеров
      # -v удаляет volume'ы (вдруг создавались временные файлы)
      - name: Остановка сервисов
        if: always()
        run: docker compose -f docker-compose.ci.yaml down -v